<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi d'Activit√©s de Classe</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/media-queries.css">
    <link rel="stylesheet" href="css/student-rows.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/activity-list.css">
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/activity-images.css">
    <link rel="stylesheet" href="css/student-photos.css">
</head>
<body>
    <!-- Lock button (available on student screens) -->
    <button id="lock-button" aria-label="Lock">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
            <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm-6 8h12v10H6V11z"/>
        </svg>
    </button>
    
    <!-- Student Name Selection Screen -->
    <div id="student-select-screen" class="screen">
        <h1>Quel est ton nom ?</h1>
        <div id="student-list" class="selection-list">
            <!-- Student names will be populated from JavaScript -->
        </div>
    </div>
    
    <!-- Student Activities Screen -->
    <div id="student-activities-screen" class="screen">
        <button id="back-to-names-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Tes activit√©s du jour</h1>
        <h2 id="student-name-display"></h2>
        <div id="student-activities-list" class="activities-list">
            <!-- Activities will be populated from JavaScript -->
        </div>
    </div>
    
    <!-- Teacher Passcode Screen -->
    <div id="passcode-screen" class="screen">
        <button id="back-from-passcode-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Acc√®s Enseignant</h1>
        <div class="passcode-container">
            <input type="password" id="passcode-input" placeholder="Mot de passe" maxlength="10">
            <button id="submit-passcode">Entrer</button>
            <div class="passcode-help">
                <button id="show-recovery-info" class="recovery-help-btn">Mot de passe oubli√© ?</button>
                <div id="recovery-info-display" class="recovery-info-box" style="display: none;">
                    <p><strong>Code de r√©cup√©ration :</strong></p>
                    <div class="recovery-code">ADMIN2025</div>
                    <p>Utilisez ce code pour vous connecter et d√©finir un nouveau mot de passe.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Teacher Management Screen -->
    <div id="teacher-screen" class="screen">
        <button id="back-to-student-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Gestion de la classe</h1>
        
        <!-- Tab navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="tracking-tab">Suivi</button>
            <button class="tab-button" data-tab="activities-tab">Activit√©s</button>
            <button class="tab-button" data-tab="settings-tab">Param√®tres</button>
        </div>
        
        <!-- Tracking Tab Content -->
        <div id="tracking-tab" class="tab-content active">
            <!-- Direct Add Student button before the grid -->
            <div class="top-action-bar">
                <button id="add-student-button" onclick="window.addStudentDirectly()" class="add-student-button-top">+ Ajouter un √©l√®ve</button>
                <button id="save-data-button" class="save-data-button">üíæ Sauvegarder</button>
                <button id="reset-data-button" class="reset-data-button">R√©initialiser les donn√©es</button>
            </div>
            
            <div class="spreadsheet-container full-width" id="tracking-container">
                <div class="spreadsheet-header" id="tracking-header">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div id="tracking-table" class="spreadsheet-body">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Activities Tab Content -->
        <div id="activities-tab" class="tab-content">
            <div class="activities-management">
                <div class="top-action-bar">
                    <button id="add-activity-button" class="add-activity-button">+ Ajouter une activit√©</button>
                </div>
                <div class="activities-list-container">
                    <table class="activities-table">
                        <thead>
                            <tr>
                                <th>Ic√¥ne</th>
                                <th>Activit√©</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activities-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab Content -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-section">
                <h3>Gestion du mot de passe</h3>
                <div class="password-management">
                    <div class="password-section">
                        <h4>Changer le mot de passe</h4>
                        <div class="form-group">
                            <label for="current-password">Mot de passe actuel :</label>
                            <input type="password" id="current-password" placeholder="Entrez le mot de passe actuel">
                        </div>
                        <div class="form-group">
                            <label for="new-password">Nouveau mot de passe :</label>
                            <input type="password" id="new-password" placeholder="Entrez le nouveau mot de passe">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirmer le nouveau mot de passe :</label>
                            <input type="password" id="confirm-password" placeholder="Confirmez le nouveau mot de passe">
                        </div>
                        <button id="change-password-btn" class="btn-primary">Changer le mot de passe</button>
                    </div>
                    
                    <div class="password-info-section">
                        <h4>Information du mot de passe actuel</h4>
                        <p>Mot de passe actuel : <span id="current-password-display">****</span> 
                        <button id="toggle-password-visibility" class="btn-view">Afficher/Masquer</button></p>
                    </div>
                    
                    <div class="recovery-section">
                        <h4>R√©cup√©ration du mot de passe</h4>
                        <p>Si vous avez oubli√© votre mot de passe, utilisez le code de r√©cup√©ration principal :</p>
                        <div class="recovery-info">
                            <strong>Code de r√©cup√©ration : ADMIN2025</strong>
                        </div>
                        <p>Ce code peut √™tre utilis√© pour vous connecter et d√©finir un nouveau mot de passe.</p>
                        <button id="reset-to-default-btn" class="btn-secondary">Remettre le mot de passe par d√©faut (1234)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Modal for adding/editing activities with emoji selection -->
    <div id="activity-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Ajouter une Activit√©</h2>
            <div class="modal-form">
                <div class="form-group">
                    <label for="activity-name">Nom de l'activit√© :</label>
                    <input type="text" id="activity-name" placeholder="Entrez le nom de l'activit√©">
                </div>
                <div class="form-group">
                    <label>Choisissez un type d'ic√¥ne :</label>
                    <div class="icon-type-selector">
                        <button type="button" id="emoji-tab-button" class="icon-tab-button active">Emoji</button>
                        <button type="button" id="image-tab-button" class="icon-tab-button">T√©l√©charger Image</button>
                    </div>
                    
                    <div id="emoji-tab-content" class="icon-tab-content active">
                        <div class="emoji-selector">
                            <div class="emoji-grid">
                                <span class="emoji-option" data-emoji="üìö">üìö</span>
                                <span class="emoji-option" data-emoji="üßÆ">üßÆ</span>
                                <span class="emoji-option" data-emoji="üî¨">üî¨</span>
                                <span class="emoji-option" data-emoji="üé®">üé®</span>
                                <span class="emoji-option" data-emoji="üìù">üìù</span>
                                <span class="emoji-option" data-emoji="üíª">üíª</span>
                                <span class="emoji-option" data-emoji="üèÉ">üèÉ</span>
                                <span class="emoji-option" data-emoji="üéµ">üéµ</span>
                                <span class="emoji-option" data-emoji="üåé">üåé</span>
                                <span class="emoji-option" data-emoji="üß©">üß©</span>
                                <span class="emoji-option" data-emoji="üìñ">üìñ</span>
                                <span class="emoji-option" data-emoji="üéÆ">üéÆ</span>
                                <span class="emoji-option" data-emoji="üé≠">üé≠</span>
                                <span class="emoji-option" data-emoji="üèõÔ∏è">üèõÔ∏è</span>
                                <span class="emoji-option" data-emoji="üó£Ô∏è">üó£Ô∏è</span>
                                <span class="emoji-option" data-emoji="üìä">üìä</span>
                            </div>
                            <input type="text" id="selected-emoji" value="üìö" readonly>
                        </div>
                    </div>
                    
                    <div id="image-tab-content" class="icon-tab-content">
                        <div class="image-upload-container">
                            <div class="image-preview-container">
                                <img id="image-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2NjY2NjYyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiPjwvY2lyY2xlPjxwb2x5bGluZSBwb2ludHM9IjIxIDE1IDEwIDIxIDMgMTUiPjwvcG9seWxpbmU+PC9zdmc+" alt="Preview">
                                <div class="no-image-message">Aucune image s√©lectionn√©e</div>
                            </div>
                            <div class="image-upload-actions">
                                <div class="custom-file-input">
                                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                                    <button type="button" class="file-input-label" onclick="document.getElementById('image-upload').click()">
                                        üìÅ Parcourir les fichiers...
                                    </button>
                                </div>
                                <div id="activity-file-name" class="file-name-display" style="display: none; margin-top: 8px; font-size: 12px; color: #666;"></div>
                                <button id="remove-image" class="btn-secondary" disabled>Supprimer l'image</button>
                            </div>
                            <input type="hidden" id="image-data" value="">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="save-activity" class="btn-primary">Sauvegarder l'Activit√©</button>
                    <button class="close-modal-btn btn-secondary">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/student-refresh.js"></script>
    <script src="js/script.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/activity-card.js"></script>
    <script src="js/activity-list.js"></script>
    <script src="js/tabs.js"></script>
    
    <!-- Direct fix for the save activity button -->
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get the save button
            const saveBtn = document.getElementById('save-activity');
            
            if (saveBtn) {
                // Remove all existing event listeners by replacing the button
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                // Add a new click handler
                newSaveBtn.addEventListener('click', function() {
                    console.log("DIRECT FIX: Save button clicked");
                    
                    // Get the modal elements
                    const modal = document.getElementById('activity-modal');
                    const nameInput = document.getElementById('activity-name');
                    const emojiInput = document.getElementById('selected-emoji');
                    const imageDataInput = document.getElementById('image-data');
                    
                    // Get the values
                    const name = nameInput.value.trim();
                    if (!name) {
                        alert('Veuillez entrer un nom d\'activit√©');
                        return;
                    }
                    
                    // Determine if we're using emoji or image
                    const emojiTab = document.getElementById('emoji-tab-content');
                    const isEmojiSelected = emojiTab.classList.contains('active');
                    
                    // Get activities from localStorage
                    let activities = [];
                    try {
                        activities = JSON.parse(localStorage.getItem('activities')) || [];
                    } catch (e) {
                        console.error("Error loading activities:", e);
                    }
                    
                    // Check if we're editing an existing activity
                    const operation = modal.getAttribute('data-operation');
                    const activityIdStr = modal.getAttribute('data-activity-id');
                    const activityId = activityIdStr ? parseInt(activityIdStr) : null;
                    
                    console.log("Operation:", operation, "Activity ID:", activityId);
                    
                    if (operation === 'edit' && activityId) {
                        // Edit existing activity
                        const index = activities.findIndex(a => a.id === activityId);
                        console.log("Activity index:", index);
                        if (index !== -1) {
                            activities[index].name = name;
                            
                            if (isEmojiSelected) {
                                activities[index].emoji = emojiInput.value;
                                delete activities[index].imageData;
                            } else {
                                activities[index].imageData = imageDataInput.value;
                                delete activities[index].emoji;
                            }
                            
                            console.log("Updated activity:", activities[index]);
                        } else {
                            console.error("Activity not found with ID:", activityId);
                        }
                    } else {
                        // Add new activity
                        const newId = activities.length > 0 ? 
                            Math.max(...activities.map(a => a.id)) + 1 : 1;
                        
                        const newActivity = {
                            id: newId,
                            name: name
                        };
                        
                        if (isEmojiSelected) {
                            newActivity.emoji = emojiInput.value;
                        } else {
                            newActivity.imageData = imageDataInput.value;
                        }
                        
                        activities.push(newActivity);
                        console.log("Added new activity:", newActivity);
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('activities', JSON.stringify(activities));
                    
                    // Close the modal
                    modal.style.display = 'none';
                    
                    // Refresh the UI
                    if (typeof window.renderActivitiesTable === 'function') {
                        window.renderActivitiesTable();
                    }
                    
                    // Force a page refresh to ensure everything is updated
                    location.reload();
                });
            }
        });
    </script>
</body>
</html>
