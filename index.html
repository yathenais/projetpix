<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi d'Activités de Classe</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/media-queries.css">
    <link rel="stylesheet" href="css/student-rows.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/activity-list.css">
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/activity-images.css">
</head>
<body>
    <!-- Lock button (available on student screens) -->
    <button id="lock-button" aria-label="Lock">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
            <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm-6 8h12v10H6V11z"/>
        </svg>
    </button>
    
    <!-- Student Name Selection Screen -->
    <div id="student-select-screen" class="screen">
        <h1>Quel est ton nom ?</h1>
        <div id="student-list" class="selection-list">
            <!-- Student names will be populated from JavaScript -->
        </div>
    </div>
    
    <!-- Student Activities Screen -->
    <div id="student-activities-screen" class="screen">
        <button id="back-to-names-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Tes activités du jour</h1>
        <h2 id="student-name-display"></h2>
        <div id="student-activities-list" class="activities-list">
            <!-- Activities will be populated from JavaScript -->
        </div>
    </div>
    
    <!-- Teacher Passcode Screen -->
    <div id="passcode-screen" class="screen">
        <button id="back-from-passcode-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Accès Enseignant</h1>
        <div class="passcode-container">
            <input type="password" id="passcode-input" placeholder="Mot de passe" maxlength="4">
            <button id="submit-passcode">Entrer</button>
        </div>
    </div>
    
    <!-- Teacher Management Screen -->
    <div id="teacher-screen" class="screen">
        <button id="back-to-student-button" class="navigation-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </button>
        <h1>Gestion de la classe</h1>
        
        <!-- Tab navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="tracking-tab">Suivi</button>
            <button class="tab-button" data-tab="activities-tab">Activités</button>
        </div>
        
        <!-- Tracking Tab Content -->
        <div id="tracking-tab" class="tab-content active">
            <!-- Direct Add Student button before the grid -->
            <div class="top-action-bar">
                <button id="add-student-button" onclick="window.addStudentDirectly()" class="add-student-button-top">+ Ajouter un élève</button>
                <button id="save-data-button" class="save-data-button">💾 Sauvegarder</button>
                <button id="reset-data-button" class="reset-data-button">Réinitialiser les données</button>
            </div>
            
            <div class="spreadsheet-container full-width" id="tracking-container">
                <div class="spreadsheet-header" id="tracking-header">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div id="tracking-table" class="spreadsheet-body">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Activities Tab Content -->
        <div id="activities-tab" class="tab-content">
            <div class="activities-management">
                <div class="top-action-bar">
                    <button id="add-activity-button" class="add-activity-button">+ Ajouter une activité</button>
                </div>
                <div class="activities-list-container">
                    <table class="activities-table">
                        <thead>
                            <tr>
                                <th>Icône</th>
                                <th>Activité</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activities-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Modal for adding/editing activities with emoji selection -->
    <div id="activity-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Ajouter une Activité</h2>
            <div class="modal-form">
                <div class="form-group">
                    <label for="activity-name">Nom de l'activité :</label>
                    <input type="text" id="activity-name" placeholder="Entrez le nom de l'activité">
                </div>
                <div class="form-group">
                    <label>Choisissez un type d'icône :</label>
                    <div class="icon-type-selector">
                        <button type="button" id="emoji-tab-button" class="icon-tab-button active">Emoji</button>
                        <button type="button" id="image-tab-button" class="icon-tab-button">Télécharger Image</button>
                    </div>
                    
                    <div id="emoji-tab-content" class="icon-tab-content active">
                        <div class="emoji-selector">
                            <div class="emoji-grid">
                                <span class="emoji-option" data-emoji="📚">📚</span>
                                <span class="emoji-option" data-emoji="🧮">🧮</span>
                                <span class="emoji-option" data-emoji="🔬">🔬</span>
                                <span class="emoji-option" data-emoji="🎨">🎨</span>
                                <span class="emoji-option" data-emoji="📝">📝</span>
                                <span class="emoji-option" data-emoji="💻">💻</span>
                                <span class="emoji-option" data-emoji="🏃">🏃</span>
                                <span class="emoji-option" data-emoji="🎵">🎵</span>
                                <span class="emoji-option" data-emoji="🌎">🌎</span>
                                <span class="emoji-option" data-emoji="🧩">🧩</span>
                                <span class="emoji-option" data-emoji="📖">📖</span>
                                <span class="emoji-option" data-emoji="🎮">🎮</span>
                                <span class="emoji-option" data-emoji="🎭">🎭</span>
                                <span class="emoji-option" data-emoji="🏛️">🏛️</span>
                                <span class="emoji-option" data-emoji="🗣️">🗣️</span>
                                <span class="emoji-option" data-emoji="📊">📊</span>
                            </div>
                            <input type="text" id="selected-emoji" value="📚" readonly>
                        </div>
                    </div>
                    
                    <div id="image-tab-content" class="icon-tab-content">
                        <div class="image-upload-container">
                            <div class="image-preview-container">
                                <img id="image-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2NjY2NjYyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiPjwvY2lyY2xlPjxwb2x5bGluZSBwb2ludHM9IjIxIDE1IDEwIDIxIDMgMTUiPjwvcG9seWxpbmU+PC9zdmc+" alt="Preview">
                                <div class="no-image-message">Aucune image sélectionnée</div>
                            </div>
                            <div class="image-upload-actions">
                                <label for="image-upload" class="custom-file-upload">
                                    Choisir une image
                                </label>
                                <input type="file" id="image-upload" accept="image/*">
                                <button id="remove-image" class="btn-secondary" disabled>Supprimer</button>
                            </div>
                            <input type="hidden" id="image-data" value="">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="save-activity" class="btn-primary">Sauvegarder l'Activité</button>
                    <button class="close-modal-btn btn-secondary">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/student-refresh.js"></script>
    <script src="js/script.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/activity-card.js"></script>
    <script src="js/activity-list.js"></script>
    <script src="js/tabs.js"></script>
    
    <!-- Direct fix for the save activity button -->
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get the save button
            const saveBtn = document.getElementById('save-activity');
            
            if (saveBtn) {
                // Remove all existing event listeners by replacing the button
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                // Add a new click handler
                newSaveBtn.addEventListener('click', function() {
                    console.log("DIRECT FIX: Save button clicked");
                    
                    // Get the modal elements
                    const modal = document.getElementById('activity-modal');
                    const nameInput = document.getElementById('activity-name');
                    const emojiInput = document.getElementById('selected-emoji');
                    const imageDataInput = document.getElementById('image-data');
                    
                    // Get the values
                    const name = nameInput.value.trim();
                    if (!name) {
                        alert('Veuillez entrer un nom d\'activité');
                        return;
                    }
                    
                    // Determine if we're using emoji or image
                    const emojiTab = document.getElementById('emoji-tab-content');
                    const isEmojiSelected = emojiTab.classList.contains('active');
                    
                    // Get activities from localStorage
                    let activities = [];
                    try {
                        activities = JSON.parse(localStorage.getItem('activities')) || [];
                    } catch (e) {
                        console.error("Error loading activities:", e);
                    }
                    
                    // Check if we're editing an existing activity
                    const operation = modal.getAttribute('data-operation');
                    const activityIdStr = modal.getAttribute('data-activity-id');
                    const activityId = activityIdStr ? parseInt(activityIdStr) : null;
                    
                    console.log("Operation:", operation, "Activity ID:", activityId);
                    
                    if (operation === 'edit' && activityId) {
                        // Edit existing activity
                        const index = activities.findIndex(a => a.id === activityId);
                        console.log("Activity index:", index);
                        if (index !== -1) {
                            activities[index].name = name;
                            
                            if (isEmojiSelected) {
                                activities[index].emoji = emojiInput.value;
                                delete activities[index].imageData;
                            } else {
                                activities[index].imageData = imageDataInput.value;
                                delete activities[index].emoji;
                            }
                            
                            console.log("Updated activity:", activities[index]);
                        } else {
                            console.error("Activity not found with ID:", activityId);
                        }
                    } else {
                        // Add new activity
                        const newId = activities.length > 0 ? 
                            Math.max(...activities.map(a => a.id)) + 1 : 1;
                        
                        const newActivity = {
                            id: newId,
                            name: name
                        };
                        
                        if (isEmojiSelected) {
                            newActivity.emoji = emojiInput.value;
                        } else {
                            newActivity.imageData = imageDataInput.value;
                        }
                        
                        activities.push(newActivity);
                        console.log("Added new activity:", newActivity);
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('activities', JSON.stringify(activities));
                    
                    // Close the modal
                    modal.style.display = 'none';
                    
                    // Refresh the UI
                    if (typeof window.renderActivitiesTable === 'function') {
                        window.renderActivitiesTable();
                    }
                    
                    // Force a page refresh to ensure everything is updated
                    location.reload();
                });
            }
        });
    </script>
</body>
</html>
